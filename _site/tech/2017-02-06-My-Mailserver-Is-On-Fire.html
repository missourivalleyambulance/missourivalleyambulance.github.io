<!doctype html>
<html class="no-js" lang="en">
<head>
		<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Everything Is On Fire</title>
	<link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/styles_feeling_responsive.css" />
	<script src="http://localhost:4000/assets/js/modernizr.min.js"></script>

  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
  <script>
    WebFont.load({
      google: {
        families: [ 'Lato:400,700,400italic:latin', 'Volkhov::latin' ]
      }
    });
  </script>

  <noscript>
    <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic|Volkhov' rel='stylesheet' type='text/css' />
  </noscript>

  
	
	<meta name="description" content="" />

	

	



	
	<link rel="icon" sizes="32x32" href="http://localhost:4000/assets/img/favicon-32x32.png" />




	
	<link rel="icon" sizes="192x192" href="http://localhost:4000/assets/img/touch-icon-192x192.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="180x180" href="http://localhost:4000/assets/img/apple-touch-icon-180x180-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="152x152" href="http://localhost:4000/assets/img/apple-touch-icon-152x152-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/assets/img/apple-touch-icon-144x144-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="120x120" href="http://localhost:4000/assets/img/apple-touch-icon-120x120-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/assets/img/apple-touch-icon-114x114-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="76x76" href="http://localhost:4000/assets/img/apple-touch-icon-76x76-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/assets/img/apple-touch-icon-72x72-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" href="http://localhost:4000/assets/img/apple-touch-icon-precomposed.png" />	




	
	<meta name="msapplication-TileImage" content="http://localhost:4000/assets/img/msapplication_tileimage.png" />




	
	<meta name="msapplication-TileColor" content="#fabb00" />



	<!-- Facebook Optimization -->
	<meta property="og:locale" content="en_EN" />
	
	<meta property="og:title" content="Everything Is On Fire" />
	<meta property="og:description" content="Missouri Valley Ambulance is the inane ramblings and various projects of a gadget geek, Apple lover, and keyboard wonk." />
	<meta property="og:url" content="http://localhost:4000//tech/2017-02-06-My-Mailserver-Is-On-Fire" />
	<meta property="og:site_name" content="MISSOURI VALLEY AMBULANCE" />
	<meta property="og:image" content="/images/http://imgur.com/8HYmOEt.jpg" />

	

	<!-- Search Engine Optimization -->
	

	<link type="text/plain" rel="author" href="http://localhost:4000/humans.txt" />

	

	
</head>
</head>
<body id="top-of-page" class="post">
	
	
<div id="navigation" class="sticky">
  <nav class="top-bar" role="navigation" data-topbar>
    <ul class="title-area">
      <li class="name">
      <center><h1 class="show-for-small-only"><a href="http://localhost:4000"> <img src="/assets/img/logo.png" alt="MVA"></a></h1></center>
    </li>
       <!-- Remove the class "menu-icon" to get rid of menu icon. Take out "Menu" to just have icon alone -->
      <li class="toggle-topbar menu-icon"><a href="#"><span></span></a></li>
    </ul>
    <section class="top-bar-section">

      <ul class="right">
        

              

          
          
            
            
              <li class="divider"></li>
              <li><a href="http://localhost:4000/">Home</a></li>

            
            
          
        

              

          
          
            
            
              <li class="divider"></li>
              <li><a href="http://localhost:4000/archive">Archive</a></li>

            
            
          
        

              

          
          
            
            

              <li class="divider"></li>
              <li class="has-dropdown">
                <a href="http://localhost:4000/projects">Projects</a>

                  <ul class="dropdown">
                    

                      

                      <li><a href="http://localhost:4000/ErgoDox_Omnibus">ErgoDox</a></li>
                    
                  </ul>

              </li>
            
          
        

              

          
          
            
            
              <li class="divider"></li>
              <li><a href="http://localhost:4000/aboutme">About</a></li>

            
            
          
        
        
      </ul>

      <ul class="left">
        

              

          
          
        

              

          
          
        

              

          
          
        

              

          
          
        
        
      </ul>
    </section>
  </nav>
</div><!-- /#navigation -->

	

	

<div id="masthead-no-image-header">
	<div class="row">
		<div class="small-12 columns">
			<center><a id="logo" href="http://localhost:4000" title="MISSOURI VALLEY AMBULANCE – "></center>
				<center><img src="http://localhost:4000/assets/img/logo.png" alt="MISSOURI VALLEY AMBULANCE – "><center>
			</a>
		</div><!-- /.small-12.columns -->
	</div><!-- /.row -->
</div><!-- /#masthead -->




<nav class="breadcrumbs" role="menubar" aria-label="breadcrumbs">
 <a href="http://localhost:4000">Home</a>
 
   
    
        <a href="http://localhost:4000/tech/">tech</a>
    
  
    
        <a class="current">Everything Is On Fire</a>
    
  
</nav>










	<div class="row t30">
	<div class="medium-8 columns medium-offset-2 end">
		<article itemscope itemtype="http://schema.org/Article">
			<header>
				
				<figure>
					<img src="http://imgur.com/8HYmOEt.jpg" width="970" alt="Everything Is On Fire" itemprop="image">

					
				</figure>
				

				<span itemprop="name">
<h1>Everything Is On Fire</h1>
					<p class="subheadline">Fixing A Broken Mailserver</p>
					
				</span>
			</header>


			<span itemprop="articleSection">
			<h3 id="some-background">Some Background</h3>

<p>For two years now I’ve been managing my own email server built on <a href="https://mailinabox.email/">Mailinabox</a>. I first built out the box in the wake of the Snowden revelations. It occurred to me that while Gmail does offer state-of-the-art encryption on their data at rest, it was entirely possible that Google would be subject to <a href="https://en.wikipedia.org/wiki/National_security_letter">NSLs</a> and definitely even mass data collection.</p>

<p>Of course, email never really was designed for security, and unless you’re using PGP on every message it’s possible for <strong>anyone</strong> listening on the wire to intercept messages as they come and go. Despite this, I felt it was best to decentralize myself - and thus remove as much of my digital identity from Google as possible.</p>

<p>If one’s threat model is a nation state actor there is no perfect defense against that, but it is possible to minimize the attack surface or at least make it a bit more difficult to be attacked or surveilled by being removed from as many centralized systems as possible. Thus, Mailinabox.</p>

<h3 id="the-first-cracks-appear">The First Cracks Appear</h3>

<p>Everything was working perfectly until a few months ago - the build of my box predated Mailinbox’s <a href="https://letsencrypt.org/">LetsEncrypt</a> integration, so I used an SSL cert issued by Comodo, and later WoSign. It was time to get myself moved off those options and on to LetsEncrypt (and in the wake of news of misdeeds by both Comodo and <a href="https://blog.mozilla.org/security/2016/10/24/distrusting-new-wosign-and-startcom-certificates/">WoSign</a> that was a good decision), however my box was being stubborn. Even if I SFTP’d into the machine and removed the existing certs, I couldn’t get any new certs to apply.</p>

<p>Digging around the <a href="https://discourse.mailinabox.email/">Mailinabox support forums</a>, I found the proper script to invoke:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>./management/ssl_certificates.py --force
</code></pre>
</div>

<p>After that the LetsEncrypt cert was successfully applied, but weird stuff started happening to the server. Where once the status pages would show me all was well, I started getting failures instead. Despite the Status Checks page failing, the box was fully functional.</p>

<blockquote>
  <p>I let the box continue to run until today - when it finally broke on me.</p>
</blockquote>

<p>Once a LetsEncrypt certificate is issued, Mailinabox is <em>supposed</em> to automatically renew the cert every 90 days. Today, my original LetsEncrypt cert expired. First warning was my phone telling me over and over again that it couldn’t connect to the mail server.</p>

<h3 id="everything-is-on-fire">Everything Is On Fire</h3>

<p>I was unable to get new emails on my phone, and my desktop machine was making similar complaints.</p>

<p>First step was to go out to the box’s admin page in an attempt to issue a new cert from the TLS console. In the interest of security, Mailinabox deployments enforce <a href="https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security">HTTP Strict Transport Security</a> (HSTS), which enforces SSL after you visit an encrypted site for the first time. HSTS is there to prevent a user from being exposed to <a href="https://en.wikipedia.org/wiki/Downgrade_attack">downgrade attacks</a>. In this case, with an expired certificate it prevented me from initiating a web connection with the site at all.</p>

<p>Next step was to SSH into the server and attempt the ssl_certificates.py script again - foiled! I got an error and it wouldn’t run. The server was telling me it had issues with OpenSSL - this was likely the result of my messing around with the server months earlier trying to force it to get a LetsEncrypt manually.</p>

<p>I <em>hoped</em> that an update would fix it, but unfortunately it did not. Just attempting to run the update to Mailinabox v0.21C didn’t work. Again I was encountering errors regarging OpenSSL.</p>

<blockquote>
  <p>Time to build a new box</p>
</blockquote>

<p>At this point I figured the only resolution was to build out a new box and attempt to migrate/recover all my data. Fortunately there is a guide on how to do that <a href="https://mailinabox.email/maintenance.html#moving-boxes">here.</a></p>

<p>First I ran a manual backup.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cd mailinabox
sudo management/backup.py
</code></pre>
</div>

<p>By default Mailinabox does daily backups, but it was best to have a totally up-to-date backup. I also went into Mail, Contacts, and Calendar on my local machine and exported everything I had, just in case I was unable to restore from the backup on to the new box.</p>

<p>Then it was time to get the backup off the machine, so I fired up FileZilla and SFTP’d into the box. Per the Mailinabox instructions it’s neccessary to only grab <em>/home/user-data/backup/secret_key.txt</em> and <em>/home/user-data/backup/encrypted</em>, but I opted to backup the entire <em>/user-data/</em> folder.</p>

<p><img src="http://imgur.com/td2P77x.jpg" alt="" /></p>

<p>I then got started spinning up a new server with <a href="https://www.digitalocean.com/">DigitalOcean</a>. It was necessary to rename my old droplet to <em>box.missourivalleyambulance.com</em> to <em>box.missourivalleyambulance.com.old</em>. I was able to get the new box up and running quickly, including the Mailinabox install. The setup for this is actually down to a single curl command.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>curl -s https://mailinabox.email/setup.sh | sudo bash
</code></pre>
</div>

<p>After the box was set up and fully configured, I went over to GoDaddy to set up the new IP address. One thing that’s brilliant about Mailinabox is that it hosts its DNS - so the only thing needed on the registrar’s end are the nameserver addresses.</p>

<p>Then it was time to SFTP into the new box, upload the <em>/user-data/backup/encrypted/</em> folder, rename the existing <em>/user-data/</em> folder to <em>/user-data-old/</em> and run the restore command.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cd mailinabox/home
export PASSPHRASE=$(cat secret_key.txt)
sudo -E duplicity restore file:///home/backups/encrypted /home/user-data/
</code></pre>
</div>

<p>A quick server reboot, and the box was back to its original configuration.</p>

<h3 id="the-fire-extinguished">The Fire Extinguished</h3>

<p>The timing for this failure was quite good actually. My domain was up for renewal with GoDaddy, expiring on 2/10. Since I was doing all this work with rebuilding the server today, I took the time go get my domain transferred over to <a href="https://www.hover.com/">Hover.</a> I’m just a few hours into being a Hover customer, but so far I’m pretty impressed. Their site offers step-by-step guides for how to get a domain released from GoDaddy and prepped for transfer to Hover. From the time I initiated the transfer until it was complete was just under an hour. Hover even automatically copied over all the nameserver glue records, so there was no fighting with those trying to get DNS working correctly with the mailserver.</p>

<p>It’s funny - when I first got this mail server up and running 2 years ago it took me ages to get everything configured correctly. The whole process took me weeks. The largest barrier was getting the old Comodo SSL cert &amp; DNS up and running correctly as I had no idea what I was doing. Today I experienced an unexpected failure of my mailserver, requiring a total rebuild. I was able to get it all resolved within a few hours. The largest parts of the rebuild today was just waiting for all <em>/user-data/</em> directory information to transfer from one server to another, and waiting for DNS records to propagate after moving the server to a new IP address.</p>

<hr />
<p align="right">Typed on ErgoDox Test Board&lt;/p
</p>

			</span>



			
						<div id="page-meta" class="t30">
				<p>
					<!-- Look the author details up from the site config. -->
					
					<!-- Output author details if some exist. -->
					
					<span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name" class="pr20 icon-edit"><a href="/Morgan" target="_blank"> Morgan</a></span>
				</span>
				

				
				<time class="icon-calendar pr20" datetime="2017-02-06" itemprop="datePublished"> 2017-02-06</time>
				

				<span class="icon-archive pr20"> TECH</span>
				<br />
				<span class="pr20"></span>
			</p>

			<div id="post-nav" class="row">
				

				<div class="show-for-small-only"><div class="small-5 columns"><a class="button tiny radius prev" href="http://localhost:4000/apple/2017-01-17-z1-MacBook-Pro-Touchbar-Lockdown">&laquo; MacBook Pro Touchbar Lockdown</a></div></div><!-- /.small-4.columns -->
				<div class="show-for-medium-up"><div class="small-5 columns"><a class="button small radius prev" href="http://localhost:4000/apple/2017-01-17-z1-MacBook-Pro-Touchbar-Lockdown">&laquo; MacBook Pro Touchbar Lockdown</a></div></div><!-- /.small-4.columns -->

				

				
				<div class="show-for-small-only"><div class="small-5 columns text-right"><a class="button tiny radius next" href="http://localhost:4000/keyboards/2017-02-09-Kinesis-Countoured-Model-110">Kinesis Contoured Model 110 &raquo;</a></div></div><!-- /.small-4.columns -->
					<div class="show-for-medium-up"><div class="small-5 columns text-right"><a class="button small radius next" href="http://localhost:4000/keyboards/2017-02-09-Kinesis-Countoured-Model-110">Kinesis Contoured Model 110 &raquo;</a></div></div><!-- /.small-4.columns -->

				
			</div>
			</div><!--  /.page-meta -->

			

			<div id="bottom" class="row t30">
					<div class="small-12 columns">
						 








<a class="left button tiny radius icon-chevron-left r15" href="/tech/2017-03-07-Blog-Theme">Next Post in TECH</a>


<a class="button tiny radius" href="/tech/2016-12-07-The-Load-Out">Previous Post in TECH<span class="icon-chevron-right"></span></a>



					</div><!-- /.small-12.columns -->
			</div>
			
			



		</article>

	</div><!-- /.medium-8.columns -->


	


	
</div><!-- /.row -->


	
	    <div id="up-to-top" class="row">
      <div class="small-12 columns" style="text-align: right;">
        <a class="iconfont" href="#top-of-page">&#xf108;</a>
      </div><!-- /.small-12.columns -->
    </div><!-- /.row -->


    <footer id="footer-content" class="bg-grau">
      <div id="footer">
        <div class="row">
          <div class="medium-6 large-5 columns">
            <h5 class="shadow-black">About This Site</h5>

            <p class="shadow-black">
              Missouri Valley Ambulance is the inane ramblings and various projects of a gadget geek, Apple lover, and keyboard wonk.
              <a href="http://localhost:4000/info/">More ›</a>
            </p>
          </div><!-- /.large-6.columns -->


          <div class="small-6 medium-3 large-3 large-offset-1 columns">
            
              
                <h5 class="shadow-black">Services</h5>
              
            
              
            
              
            
              
            

              <ul class="no-bullet shadow-black">
              
                
                  <li >
                    <a href=""  title=""></a>
                  </li>
              
                
                  <li >
                    <a href="/feed.xml"  title="Subscribe to RSS Feed">RSS</a>
                  </li>
              
                
                  <li >
                    <a href="/atom.xml"  title="Subscribe to Atom Feed">Atom</a>
                  </li>
              
                
                  <li >
                    <a href="/sitemap.xml"  title="Sitemap for Google Webmaster Tools">sitemap.xml</a>
                  </li>
              
              </ul>
          </div><!-- /.large-4.columns -->


          <div class="small-6 medium-3 large-3 columns">
            
              
                <h5 class="shadow-black">Credits</h5>
              
            
              
            
              
            
              
            
              
            

            <ul class="no-bullet shadow-black">
            
              
                <li >
                  <a href=""  title=""></a>
                </li>
            
              
                <li class="network-entypo" >
                  <a href="http://entypo.com/" target="_blank"  title="Icons by Daniel Bruce">Icons by Daniel Bruce</a>
                </li>
            
              
                <li class="services-newsletter" >
                  <a href="http://foundation.zurb.com/" target="_blank"  title="Built on Foundation">Built on Foundation</a>
                </li>
            
              
                <li class="sitemap-link" >
                  <a href="http://srobbin.com/jquery-plugins/backstretch/" target="_blank"  title="Using Backstretch by Scott Robbin">Using Backstretch by Scott Robbin</a>
                </li>
            
              
                <li class="sitemap-link" >
                  <a href="https://github.com/Phlow/feeling-responsive" target="_blank"  title="Built on Feeling Responsive by Phlow">Built on Feeling Responsive by Phlow</a>
                </li>
            
            </ul>
          </div><!-- /.large-3.columns -->
        </div><!-- /.row -->

      </div><!-- /#footer -->


      <div id="subfooter">
        <nav class="row">
          <section id="subfooter-left" class="b30 small-12 medium-6 columns credits">
            <p>
     Contact:
            </p>
          </section>

          <section id="subfooter-right" class="small-12 medium-6 columns social-icons">
            <ul class="inline-list">
            
              <li><a href="http://twitter.com/mvambulance" target="_blank" class="icon-twitter" title=""></a></li>
            
              <li><a href="mailto:blog@missourivalleyambulance.com" target="_blank" class="icon-mail" title=""></a></li>
            
            </ul>
          </section>
        </nav>
      </div><!-- /#subfooter -->
    </footer>

	

	


<script src="http://localhost:4000/assets/js/javascript.min.js"></script>














</body>
</html>

